# 藥房模組功能規格

## 概述

藥房人員使用的功能，包含待配藥清單、配藥作業、庫存扣減。

**優先級：P0（最高）**
**使用設備：手機**

---

## 1. 待配藥清單

### 1.1 UI 需求

```
┌─────────────────────────────────────┐
│  💊 配藥                待配: 8    │
├─────────────────────────────────────┤
│                                     │
│  🔴 緊急                            │
│  ┌─────────────────────────────┐   │
│  │ #15 王小明     10:35         │   │
│  │ 感冒方 3種 / 7天             │   │
│  │ [ 開始配藥 ]                 │   │
│  └─────────────────────────────┘   │
│                                     │
│  ⏳ 等待中                          │
│  ┌─────────────────────────────┐   │
│  │ #16 李大華     10:38         │   │
│  │ 腸胃方 2種 / 5天             │   │
│  ├─────────────────────────────┤   │
│  │ #17 張美玲     10:42         │   │
│  │ 調理方 4種 / 14天            │   │
│  ├─────────────────────────────┤   │
│  │ #18 陳志明     10:45         │   │
│  │ 感冒方 2種 / 7天             │   │
│  └─────────────────────────────┘   │
│                                     │
└─────────────────────────────────────┘
```

### 1.2 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 待配清單 | 即時更新待配藥處方 | ❌ 未實作 |
| 優先排序 | 依等待時間排序 | ❌ 未實作 |
| 緊急標記 | 顯示急件 | ❌ 未實作 |
| 處方預覽 | 顯示藥品種類/天數 | ❌ 未實作 |
| 開始配藥 | 進入配藥作業 | ❌ 未實作 |

---

## 2. 配藥作業

### 2.1 配藥流程

```
開始配藥
    ↓
顯示處方明細
    ↓
依序配藥（掃碼確認）
    ↓
確認劑量
    ↓
扣庫存
    ↓
列印藥袋
    ↓
完成配藥
```

### 2.2 配藥畫面

```
┌─────────────────────────────────────┐
│  配藥中 - #15 王小明                │
├─────────────────────────────────────┤
│                                     │
│  進度: 1/3                          │
│  ████████░░░░░░░░░░░░░░░░░░ 33%    │
│                                     │
│  目前藥品:                          │
│  ┌─────────────────────────────┐   │
│  │ 📦 感冒方                    │   │
│  │                              │   │
│  │ 需求: 63g (3g × TID × 7天)  │   │
│  │                              │   │
│  │ 藥房庫存: 150g ✅            │   │
│  │                              │   │
│  │ 實際配藥: [ 63    ] g        │   │
│  │                              │   │
│  └─────────────────────────────┘   │
│                                     │
│  [ 庫存不足 ]  [ 確認，下一項 ]     │
│                                     │
├─────────────────────────────────────┤
│  剩餘藥品:                          │
│  ├─ 咳嗽方 42g                     │
│  └─ 解熱方 31.5g                   │
└─────────────────────────────────────┘
```

### 2.3 庫存不足處理

```
┌─────────────────────────────────────┐
│  ⚠️ 庫存不足                        │
├─────────────────────────────────────┤
│                                     │
│  感冒方                             │
│  需求: 63g                          │
│  藥房庫存: 20g                      │
│  不足: 43g                          │
│                                     │
│  處理方式:                          │
│  ┌─────────────────────────────┐   │
│  │ ○ 從庫房調撥 (庫存: 500g)   │   │
│  │ ○ 減量配藥 (只配 20g)       │   │
│  │ ○ 通知醫師更換藥品          │   │
│  └─────────────────────────────┘   │
│                                     │
│     [ 取消 ]      [ 確認 ]          │
└─────────────────────────────────────┘
```

### 2.4 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 處方明細顯示 | 藥品/劑量/頻率/天數 | ❌ 未實作 |
| 庫存檢查 | 即時顯示藥房庫存 | ❌ 未實作 |
| 配藥量輸入 | 數字鍵盤輸入 | ❌ 未實作 |
| 條碼確認 | 掃碼驗證藥品 | ❌ 未實作 |
| 庫存不足處理 | 調撥/減量/通知 | ❌ 未實作 |
| 進度顯示 | 顯示配藥進度 | ❌ 未實作 |
| 批號記錄 | 記錄使用批號 | ❌ 未實作 |

---

## 3. 扣庫存機制

### 3.1 扣庫存時機

| 藥品類型 | 扣庫存時機 | 說明 |
|----------|------------|------|
| 科學中藥 | 配藥完成時 | 一般處理 |
| 藥粉 | 配藥完成時 | 一般處理 |
| 袋裝 | 配藥完成時 | 一般處理 |
| 水藥-散賣 | 交付時 | 可退貨 |
| 水藥-整包 | 交付時 | 可退貨 |
| 水藥-煮袋 | **下鍋時** | 煮了不能退 |

### 3.2 倉庫優先順序

```
扣庫存優先順序:
1. 藥房倉庫（優先）
2. 庫房（藥房不夠時）
3. 前台（少量常用藥）
```

### 3.3 庫存服務介面

```typescript
interface DispensingInventoryService {
  // 檢查處方所需庫存
  checkPrescriptionStock(prescriptionId: number): Promise<StockCheckResult>

  // 扣減庫存（配藥完成時）
  deductStock(prescriptionId: number, lines: DeductLine[]): Promise<DeductResult>

  // 從庫房調撥到藥房
  requestTransfer(productId: number, quantity: number): Promise<TransferRequest>

  // 記錄開罐
  recordOpenJar(productId: number, batchNumber: string): Promise<void>
}

interface StockCheckResult {
  sufficient: boolean
  lines: {
    productId: number
    productName: string
    required: number
    pharmacyStock: number
    warehouseStock: number
    status: 'OK' | 'NEED_TRANSFER' | 'SHORTAGE'
  }[]
}

interface DeductLine {
  prescriptionLineId: number
  productId: number
  quantity: number
  warehouseId: number         // 來源倉庫
  batchNumber?: string        // 批號
}
```

---

## 4. 藥袋列印

### 4.1 藥袋內容

```
┌─────────────────────────────────────┐
│  怡壽診所                           │
│  ─────────────────────────────────  │
│  姓名: 王小明        性別: 男       │
│  年齡: 46 歲                        │
│  ─────────────────────────────────  │
│  藥品: 感冒方                       │
│  用法: 每次 3g，每日三次，飯後服用  │
│  天數: 7 天                         │
│  ─────────────────────────────────  │
│  開藥日期: 2026/02/06               │
│  醫師: 陳醫師                       │
│  ─────────────────────────────────  │
│  注意事項:                          │
│  請依醫囑服用，如有不適請回診       │
└─────────────────────────────────────┘
```

### 4.2 列印功能

| 功能 | 說明 | 狀態 |
|------|------|------|
| 藥袋列印 | 每種藥一個藥袋 | ❌ 未實作 |
| 整包列印 | 所有藥品一張清單 | ❌ 未實作 |
| 連續列印 | 批次列印多張 | ❌ 未實作 |
| 補印功能 | 重新列印藥袋 | ❌ 未實作 |

---

## 5. 水藥/煮藥特殊處理

### 5.1 煮袋藥流程

```
收到煮藥處方
    ↓
檢查原料庫存
    ↓
【下鍋時扣庫存】← 重點！
    ↓
煮藥中（記錄開始時間）
    ↓
煮藥完成（記錄完成時間）
    ↓
分裝
    ↓
交付病人
```

### 5.2 煮藥介面

```
┌─────────────────────────────────────┐
│  🍵 煮藥作業                        │
├─────────────────────────────────────┤
│                                     │
│  處方: #15 王小明                   │
│  帖數: 7 帖                         │
│                                     │
│  藥材清單:                          │
│  ├─ 黃耆 30g ✅                    │
│  ├─ 當歸 15g ✅                    │
│  ├─ 白芍 10g ✅                    │
│  └─ 甘草 5g ✅                     │
│                                     │
│  狀態: 準備中                       │
│                                     │
│  [ 開始煮藥 ]                       │
│  （點擊後將扣除庫存）               │
│                                     │
└─────────────────────────────────────┘
```

### 5.3 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 煮藥清單 | 待煮藥處方列表 | ❌ 未實作 |
| 藥材檢查 | 確認原料齊全 | ❌ 未實作 |
| 下鍋記錄 | 記錄開始煮藥時間 | ❌ 未實作 |
| 庫存扣減 | 下鍋時扣庫存 | ❌ 未實作 |
| 完成記錄 | 記錄煮藥完成 | ❌ 未實作 |

---

## 6. 庫存狀態顯示

### 6.1 顏色標示

| 狀態 | 顏色 | 條件 |
|------|------|------|
| 充足 | 🟢 綠 | 藥房庫存 >= 需求 |
| 需調撥 | 🟡 黃 | 藥房不夠，但庫房有 |
| 缺貨 | 🔴 紅 | 完全沒有 |

### 6.2 快速調撥

```
┌─────────────────────────────────────┐
│  快速調撥                           │
├─────────────────────────────────────┤
│                                     │
│  🔍 [ 掃描藥品條碼...          ]    │
│                                     │
│  或選擇常用藥品:                    │
│  ┌─────────┐ ┌─────────┐           │
│  │ 感冒方  │ │ 咳嗽方  │           │
│  │ 藥房:20 │ │ 藥房:50 │           │
│  │ 🟡 低   │ │ 🟢 足   │           │
│  └─────────┘ └─────────┘           │
│                                     │
└─────────────────────────────────────┘
```

---

## 7. 實作優先順序

### Phase 1: 基礎配藥
1. [ ] 待配藥清單
2. [ ] 處方明細顯示
3. [ ] 基本配藥流程
4. [ ] 完成配藥

### Phase 2: 庫存整合
1. [ ] 庫存檢查
2. [ ] 庫存扣減
3. [ ] 庫存不足處理
4. [ ] 調撥請求

### Phase 3: 進階功能
1. [ ] 條碼驗證
2. [ ] 藥袋列印
3. [ ] 批號記錄
4. [ ] 煮藥處理

### Phase 4: 效率優化
1. [ ] 批次配藥
2. [ ] 快速調撥
3. [ ] 配藥統計
