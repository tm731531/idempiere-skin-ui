# 櫃檯模組功能規格

## 概述

櫃檯人員使用的功能，包含掛號、叫號、結帳。

**優先級：P0（最高）**
**使用設備：平板**

---

## 1. 掛號功能

### 1.1 掛號流程

```
插入健保卡
    ↓
讀取卡片資料
    ↓
[新病人?] → 建立病人資料
    ↓
選擇看診醫師
    ↓
取得號碼牌
    ↓
列印掛號單
    ↓
寫入健保卡（就醫紀錄）
```

### 1.2 UI 需求

#### 掛號主畫面
```
┌─────────────────────────────────────┐
│  🏥 掛號                    [登出]  │
├─────────────────────────────────────┤
│                                     │
│     ┌─────────────────────┐         │
│     │                     │         │
│     │   請插入健保卡      │         │
│     │                     │         │
│     │   💳                │         │
│     │                     │         │
│     └─────────────────────┘         │
│                                     │
│     [ 手動輸入身分證 ]              │
│                                     │
├─────────────────────────────────────┤
│  今日掛號: 45 人  │  候診中: 12 人  │
└─────────────────────────────────────┘
```

#### 確認掛號畫面
```
┌─────────────────────────────────────┐
│  確認掛號                           │
├─────────────────────────────────────┤
│                                     │
│  姓名：王小明                       │
│  身分證：A123456789                 │
│  生日：1980/01/15 (46歲)           │
│  性別：男                           │
│                                     │
│  ⚠️ 注意病人  💊 藥物過敏           │
│                                     │
├─────────────────────────────────────┤
│  選擇醫師：                         │
│  ┌─────────┐  ┌─────────┐          │
│  │ 陳醫師  │  │ 林醫師  │          │
│  │ 候診 5人│  │ 候診 8人│          │
│  └─────────┘  └─────────┘          │
├─────────────────────────────────────┤
│                                     │
│     [ 取消 ]      [ 確認掛號 ]      │
│                                     │
└─────────────────────────────────────┘
```

### 1.3 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 健保卡讀取 | 自動讀取病人資料 | ❌ 未實作 |
| 手動輸入 | 健保卡故障時使用 | ❌ 未實作 |
| 新病人建檔 | 第一次就診自動建立 | ❌ 未實作 |
| 醫師選擇 | 顯示候診人數 | ❌ 未實作 |
| 號碼牌列印 | 印出候診號碼 | ❌ 未實作 |
| 健保卡寫入 | 寫入就醫紀錄 | ❌ 未實作 |
| 過敏提醒 | 顯示病人過敏史 | ❌ 未實作 |
| 欠款提醒 | 顯示未結清款項 | ❌ 未實作 |

### 1.4 資料結構

```typescript
interface RegistrationForm {
  patientId?: number          // 病人 ID（既有病人）
  idNumber: string            // 身分證字號
  name: string                // 姓名
  birthday: string            // 生日
  gender: 'M' | 'F'           // 性別
  phone?: string              // 電話
  doctorId: number            // 看診醫師
  visitType: 'FIRST' | 'RETURN'  // 初診/複診
  nhiCardData?: NHICardData   // 健保卡資料
}
```

---

## 2. 叫號功能

### 2.1 叫號流程

```
顯示候診清單
    ↓
點擊「下一位」
    ↓
更新看板顯示
    ↓
播放叫號語音（可選）
    ↓
等待病人入診間
    ↓
開始看診
```

### 2.2 UI 需求

#### 叫號看板（大螢幕顯示）
```
┌─────────────────────────────────────────────────┐
│                                                 │
│              🔔 請 15 號 王小明                 │
│                                                 │
│                 至 陳醫師 診間                   │
│                                                 │
├─────────────────────────────────────────────────┤
│  等候中：16, 17, 18, 19, 20                     │
├─────────────────────────────────────────────────┤
│  陳醫師 候診 5 人  │  林醫師 候診 8 人          │
└─────────────────────────────────────────────────┘
```

#### 櫃檯叫號操作畫面
```
┌─────────────────────────────────────┐
│  叫號管理                           │
├─────────────────────────────────────┤
│  陳醫師                             │
│  ┌─────────────────────────────┐   │
│  │ ▶ 15 王小明     10:15 掛號  │   │
│  │   16 李大華     10:18 掛號  │   │
│  │   17 張美玲     10:22 掛號  │   │
│  │   18 陳志明     10:25 掛號  │   │
│  └─────────────────────────────┘   │
│                                     │
│  [ 叫下一位 ]  [ 過號 ]  [ 插隊 ]   │
│                                     │
├─────────────────────────────────────┤
│  林醫師                             │
│  ┌─────────────────────────────┐   │
│  │ ▶ 23 趙小芬     10:12 掛號  │   │
│  │   24 黃建國     10:20 掛號  │   │
│  └─────────────────────────────┘   │
│                                     │
│  [ 叫下一位 ]  [ 過號 ]  [ 插隊 ]   │
└─────────────────────────────────────┘
```

### 2.3 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 候診清單 | 即時更新候診名單 | ❌ 未實作 |
| 叫號按鈕 | 叫下一位病人 | ❌ 未實作 |
| 過號處理 | 病人未到場 | ❌ 未實作 |
| 插隊功能 | 緊急病人優先 | ❌ 未實作 |
| 看板顯示 | 大螢幕即時更新 | ❌ 未實作 |
| 語音叫號 | TTS 播報 | ❌ 未實作 |
| 候診人數 | 顯示各醫師候診數 | ❌ 未實作 |

### 2.4 即時同步

```typescript
// WebSocket 事件
interface QueueEvents {
  // 新掛號
  'registration:new': {
    registration: Registration
    doctorId: number
    queueNumber: number
  }

  // 叫號
  'queue:call': {
    doctorId: number
    queueNumber: number
    patientName: string
  }

  // 過號
  'queue:skip': {
    doctorId: number
    queueNumber: number
  }

  // 完成看診
  'consultation:complete': {
    doctorId: number
    queueNumber: number
  }
}
```

---

## 3. 結帳功能

### 3.1 結帳流程

```
叫號結帳（病人看診完）
    ↓
顯示費用明細
    ↓
確認健保點數
    ↓
計算自付額
    ↓
收款
    ↓
列印收據
    ↓
完成
```

### 3.2 UI 需求

#### 結帳畫面
```
┌─────────────────────────────────────┐
│  結帳 - 15 號 王小明                │
├─────────────────────────────────────┤
│                                     │
│  健保點數明細：                     │
│  ├─ 診察費         300 點          │
│  ├─ 藥費           450 點          │
│  ├─ 藥事服務費      48 點          │
│  └─ 合計           798 點          │
│                                     │
│  部分負擔：         50 元           │
│  自費項目：          0 元           │
│  ─────────────────────             │
│  應付金額：         50 元           │
│                                     │
├─────────────────────────────────────┤
│  付款方式：                         │
│  ○ 現金  ○ 信用卡  ○ 行動支付      │
│                                     │
│  收款金額：[ 100    ] 元            │
│  找零：     50 元                   │
│                                     │
├─────────────────────────────────────┤
│                                     │
│     [ 取消 ]      [ 完成結帳 ]      │
│                                     │
└─────────────────────────────────────┘
```

### 3.3 功能需求

| 功能 | 說明 | 狀態 |
|------|------|------|
| 費用明細 | 顯示健保/自費項目 | ❌ 未實作 |
| 部分負擔計算 | 依身分別計算 | ❌ 未實作 |
| 多種付款方式 | 現金/信用卡/行動支付 | ❌ 未實作 |
| 找零計算 | 自動計算找零 | ❌ 未實作 |
| 收據列印 | 列印正式收據 | ❌ 未實作 |
| 發票開立 | 電子發票 | ❌ 未實作 |
| 欠款記錄 | 記錄未付清款項 | ❌ 未實作 |

### 3.4 資料結構

```typescript
interface CheckoutData {
  registrationId: number
  patient: Patient
  prescription: Prescription

  // 健保點數
  nhiPoints: {
    consultationFee: number
    medicineFee: number
    pharmacyFee: number
    totalPoints: number
  }

  // 費用
  fees: {
    copayment: number         // 部分負擔
    selfPay: number           // 自費項目
    total: number             // 應付總額
  }

  // 付款
  payment: {
    method: 'CASH' | 'CARD' | 'MOBILE'
    amount: number
    change: number
  }
}
```

---

## 4. 候診狀態顏色

| 人數 | 顏色 | CSS Class |
|------|------|-----------|
| 0-3 人 | 🟢 綠色 | `status-normal` |
| 4-10 人 | 🟡 黃色 | `status-busy` |
| 10+ 人 | 🔴 紅色 | `status-urgent` |

---

## 5. 實作優先順序

### Phase 1: 基礎掛號
1. [ ] 手動輸入身分證掛號
2. [ ] 病人資料顯示
3. [ ] 醫師選擇
4. [ ] 取得候診號碼

### Phase 2: 健保卡整合
1. [ ] 健保卡讀取
2. [ ] 自動帶入資料
3. [ ] 健保卡寫入
4. [ ] 就醫序號處理

### Phase 3: 叫號系統
1. [ ] 候診清單顯示
2. [ ] 叫號操作
3. [ ] 看板即時更新
4. [ ] 語音播報

### Phase 4: 結帳功能
1. [ ] 費用明細顯示
2. [ ] 部分負擔計算
3. [ ] 收款處理
4. [ ] 收據列印
